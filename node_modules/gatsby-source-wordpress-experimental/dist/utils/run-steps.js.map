{"version":3,"sources":["../../src/utils/run-steps.js"],"names":["runSteps","steps","helpers","pluginOptions","apiName","step","timeBuildSteps","debug","timeStep","includes","name","activity","reporter","activityTimer","useVerboseStyle","start","Array","isArray","end","e","error","panic","runApiSteps","runApisInSteps","nodeApis","Object","entries","reduce","gatsbyNodeExportObject","apiSteps"],"mappings":";;;;;AAAA;;AAEA,MAAMA,QAAQ,GAAG,OAAOC,KAAP,EAAcC,OAAd,EAAuBC,aAAvB,EAAsCC,OAAtC,KAAkD;AACjE,OAAK,MAAMC,IAAX,IAAmBJ,KAAnB,EAA0B;AACxB,QAAI;AAAA;;AACF,YAAM;AAAEK,QAAAA;AAAF,kCAAqBH,aAArB,aAAqBA,aAArB,uBAAqBA,aAAa,CAAEI,KAApC,uEAA6C,EAAnD;AACA,YAAMC,QAAQ,GACZ,OAAOF,cAAP,KAA2B,SAA3B,GACIA,cADJ,GAEI,CAAAA,cAAc,SAAd,IAAAA,cAAc,WAAd,YAAAA,cAAc,CAAEG,QAAhB,CAAyBJ,IAAI,CAACK,IAA9B,OACAJ,cADA,aACAA,cADA,uBACAA,cAAc,CAAEG,QAAhB,CAAyBL,OAAzB,CADA,CAHN;AAMA,UAAIO,QAAJ;;AAEA,UAAIH,QAAJ,EAAc;AACZG,QAAAA,QAAQ,GAAGT,OAAO,CAACU,QAAR,CAAiBC,aAAjB,CACT,wCAAkB,SAAQ,CAACT,OAAD,GAAY,GAAZ,GAAkB,EAAE,KAAIC,IAAI,CAACK,IAAK,EAA5D,EAA+D;AAC7DI,UAAAA,eAAe,EAAE;AAD4C,SAA/D,CADS,CAAX;AAKAH,QAAAA,QAAQ,CAACI,KAAT;AACD;;AAED,UAAI,OAAOV,IAAP,KAAiB,UAArB,EAAgC;AAC9B,cAAMA,IAAI,CAACH,OAAD,EAAUC,aAAV,CAAV;AACD,OAFD,MAEO,IAAIa,KAAK,CAACC,OAAN,CAAcZ,IAAd,CAAJ,EAAyB;AAC9B,cAAML,QAAQ,CAACK,IAAD,EAAOH,OAAP,EAAgBC,aAAhB,EAA+BC,OAA/B,CAAd;AACD;;AAED,UAAIO,QAAJ,EAAc;AACZA,QAAAA,QAAQ,CAACO,GAAT;AACD;AACF,KA5BD,CA4BE,OAAOC,CAAP,EAAU;AACVjB,MAAAA,OAAO,CAACU,QAAR,CAAiBQ,KAAjB,CAAuBD,CAAvB;AACAjB,MAAAA,OAAO,CAACU,QAAR,CAAiBS,KAAjB,CACE,wCACG,uDACCjB,OAAO,GAAI,GAAEA,OAAQ,GAAd,GAAoB,EAC5B,GAAEC,IAAI,CAACK,IAAK,iDAHf,EAIE;AAAEI,QAAAA,eAAe,EAAE;AAAnB,OAJF,CADF;AAQD;AACF;AACF,CA1CD;;;;AA4CA,MAAMQ,WAAW,GAAG,CAACrB,KAAD,EAAQG,OAAR,KAAoB,OAAOF,OAAP,EAAgBC,aAAhB,KACtCH,QAAQ,CAACC,KAAD,EAAQC,OAAR,EAAiBC,aAAjB,EAAgCC,OAAhC,CADV;;AAGA,MAAMmB,cAAc,GAAIC,QAAD,IACrBC,MAAM,CAACC,OAAP,CAAeF,QAAf,EAAyBG,MAAzB,CACE,CAACC,sBAAD,EAAyB,CAACxB,OAAD,EAAUyB,QAAV,CAAzB,uBACKD,sBADL;AAEE,GAACxB,OAAD,GAAWkB,WAAW,CAACO,QAAD,EAAWzB,OAAX;AAFxB,EADF,EAKE,EALF,CADF","sourcesContent":["import { formatLogMessage } from \"~/utils/format-log-message\"\n\nconst runSteps = async (steps, helpers, pluginOptions, apiName) => {\n  for (const step of steps) {\n    try {\n      const { timeBuildSteps } = pluginOptions?.debug ?? {}\n      const timeStep =\n        typeof timeBuildSteps === `boolean`\n          ? timeBuildSteps\n          : timeBuildSteps?.includes(step.name) ||\n            timeBuildSteps?.includes(apiName)\n\n      let activity\n\n      if (timeStep) {\n        activity = helpers.reporter.activityTimer(\n          formatLogMessage(`step -${!apiName ? `-` : ``}> ${step.name}`, {\n            useVerboseStyle: true,\n          })\n        )\n        activity.start()\n      }\n\n      if (typeof step === `function`) {\n        await step(helpers, pluginOptions)\n      } else if (Array.isArray(step)) {\n        await runSteps(step, helpers, pluginOptions, apiName)\n      }\n\n      if (activity) {\n        activity.end()\n      }\n    } catch (e) {\n      helpers.reporter.error(e)\n      helpers.reporter.panic(\n        formatLogMessage(\n          `\\n\\n\\tEncountered a critical error when running the ${\n            apiName ? `${apiName}.` : ``\n          }${step.name} build step.\\n\\tSee above for more information.`,\n          { useVerboseStyle: true }\n        )\n      )\n    }\n  }\n}\n\nconst runApiSteps = (steps, apiName) => async (helpers, pluginOptions) =>\n  runSteps(steps, helpers, pluginOptions, apiName)\n\nconst runApisInSteps = (nodeApis) =>\n  Object.entries(nodeApis).reduce(\n    (gatsbyNodeExportObject, [apiName, apiSteps]) => ({\n      ...gatsbyNodeExportObject,\n      [apiName]: runApiSteps(apiSteps, apiName),\n    }),\n    {}\n  )\n\nexport { runSteps, runApisInSteps }\n"],"file":"run-steps.js"}